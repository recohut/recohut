---

title: Message Passing


keywords: fastai
sidebar: home_sidebar

summary: "Implementation of message passing graph network layers like LightGCN, LR-GCCF etc."
description: "Implementation of message passing graph network layers like LightGCN, LR-GCCF etc."
nb_path: "nbs/layers/layers.message_passing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/layers/layers.message_passing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LightGConv" class="doc_header"><code>class</code> <code>LightGConv</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/layers/message_passing.py#L13" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LightGConv</code>() :: <code>MessagePassing</code></p>
</blockquote>
<p>Base class for creating message passing layers of the form</p>
<p>.. math::
    \mathbf{x}<em>i^{\prime} = \gamma</em>{\mathbf{\Theta}} \left( \mathbf{x}<em>i,
    \square</em>{j \in \mathcal{N}(i)} \, \phi_{\mathbf{\Theta}}
    \left(\mathbf{x}_i, \mathbf{x}<em>j,\mathbf{e}</em>{j,i}\right) \right),</p>
<p>where :math:<code>\square</code> denotes a differentiable, permutation invariant
function, <em>e.g.</em>, sum, mean or max, and :math:<code>\gamma_{\mathbf{\Theta}}</code>
and :math:<code>\phi_{\mathbf{\Theta}}</code> denote differentiable functions such as
MLPs.
See <code>here &lt;https://pytorch-geometric.readthedocs.io/en/latest/notes/
create_gnn.html&gt;</code>__ for the accompanying tutorial.</p>
<p>Args:
    aggr (string, optional): The aggregation scheme to use
        (:obj:<code>"add"</code>, :obj:<code>"mean"</code>, :obj:<code>"max"</code> or :obj:<code>None</code>).
        (default: :obj:<code>"add"</code>)
    flow (string, optional): The flow direction of message passing
        (:obj:<code>"source_to_target"</code> or :obj:<code>"target_to_source"</code>).
        (default: :obj:<code>"source_to_target"</code>)
    node_dim (int, optional): The axis along which to propagate.
        (default: :obj:<code>-2</code>)
    decomposed<em>layers (int, optional): The number of feature decomposition
        layers, as introduced in the <code>"Optimizing Memory Efficiency of
        Graph Neural Networks on Edge Computing Platforms"
        &lt;https://arxiv.org/abs/2104.03058&gt;</code></em> paper.
        Feature decomposition reduces the peak memory usage by slicing
        the feature dimensions into separated feature decomposition layers
        during GNN aggregation.
        This method can accelerate GNN execution on CPU-based platforms
        (<em>e.g.</em>, 2-3x speedup on the
        :class:<code>~torch_geometric.datasets.Reddit</code> dataset) for common GNN
        models such as :class:<code>~torch_geometric.nn.models.GCN</code>,
        :class:<code>~torch_geometric.nn.models.GraphSAGE</code>,
        :class:<code>~torch_geometric.nn.models.GIN</code>, etc.
        However, this method is not applicable to all GNN operators
        available, in particular for operators in which message computation
        can not easily be decomposed, <em>e.g.</em> in attention-based GNNs.
        The selection of the optimal value of :obj:<code>decomposed_layers</code>
        depends both on the specific graph dataset and available hardware
        resources.
        A value of :obj:<code>2</code> is suitable in most cases.
        Although the peak memory usage is directly associated with the
        granularity of feature decomposition, the same is not necessarily
        true for execution speedups. (default: :obj:<code>1</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LRGCCF" class="doc_header"><code>class</code> <code>LRGCCF</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/layers/message_passing.py#L32" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LRGCCF</code>(<strong><code>in_channels</code></strong>, <strong><code>out_channels</code></strong>) :: <code>MessagePassing</code></p>
</blockquote>
<p>Base class for creating message passing layers of the form</p>
<p>.. math::
    \mathbf{x}<em>i^{\prime} = \gamma</em>{\mathbf{\Theta}} \left( \mathbf{x}<em>i,
    \square</em>{j \in \mathcal{N}(i)} \, \phi_{\mathbf{\Theta}}
    \left(\mathbf{x}_i, \mathbf{x}<em>j,\mathbf{e}</em>{j,i}\right) \right),</p>
<p>where :math:<code>\square</code> denotes a differentiable, permutation invariant
function, <em>e.g.</em>, sum, mean or max, and :math:<code>\gamma_{\mathbf{\Theta}}</code>
and :math:<code>\phi_{\mathbf{\Theta}}</code> denote differentiable functions such as
MLPs.
See <code>here &lt;https://pytorch-geometric.readthedocs.io/en/latest/notes/
create_gnn.html&gt;</code>__ for the accompanying tutorial.</p>
<p>Args:
    aggr (string, optional): The aggregation scheme to use
        (:obj:<code>"add"</code>, :obj:<code>"mean"</code>, :obj:<code>"max"</code> or :obj:<code>None</code>).
        (default: :obj:<code>"add"</code>)
    flow (string, optional): The flow direction of message passing
        (:obj:<code>"source_to_target"</code> or :obj:<code>"target_to_source"</code>).
        (default: :obj:<code>"source_to_target"</code>)
    node_dim (int, optional): The axis along which to propagate.
        (default: :obj:<code>-2</code>)
    decomposed<em>layers (int, optional): The number of feature decomposition
        layers, as introduced in the <code>"Optimizing Memory Efficiency of
        Graph Neural Networks on Edge Computing Platforms"
        &lt;https://arxiv.org/abs/2104.03058&gt;</code></em> paper.
        Feature decomposition reduces the peak memory usage by slicing
        the feature dimensions into separated feature decomposition layers
        during GNN aggregation.
        This method can accelerate GNN execution on CPU-based platforms
        (<em>e.g.</em>, 2-3x speedup on the
        :class:<code>~torch_geometric.datasets.Reddit</code> dataset) for common GNN
        models such as :class:<code>~torch_geometric.nn.models.GCN</code>,
        :class:<code>~torch_geometric.nn.models.GraphSAGE</code>,
        :class:<code>~torch_geometric.nn.models.GIN</code>, etc.
        However, this method is not applicable to all GNN operators
        available, in particular for operators in which message computation
        can not easily be decomposed, <em>e.g.</em> in attention-based GNNs.
        The selection of the optimal value of :obj:<code>decomposed_layers</code>
        depends both on the specific graph dataset and available hardware
        resources.
        A value of :obj:<code>2</code> is suitable in most cases.
        Although the peak memory usage is directly associated with the
        granularity of feature decomposition, the same is not necessarily
        true for execution speedups. (default: :obj:<code>1</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;userId&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
     <span class="s1">&#39;itemId&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
     <span class="s1">&#39;rating&#39;</span><span class="p">:[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]}</span>
<span class="p">)</span>

<span class="n">train</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-39fda5a9-0920-4ce6-bdff-1168e6b59365">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>itemId</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4</td>
      <td>4</td>
      <td>2</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5</td>
      <td>5</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-39fda5a9-0920-4ce6-bdff-1168e6b59365')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-39fda5a9-0920-4ce6-bdff-1168e6b59365 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-39fda5a9-0920-4ce6-bdff-1168e6b59365');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch_geometric.data</span> <span class="kn">import</span> <span class="n">Data</span>

<span class="n">E</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">edge_user</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">edge_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;itemId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">edge_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">edge_user</span><span class="p">,</span><span class="n">edge_item</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">edge_item</span><span class="p">,</span><span class="n">edge_user</span><span class="p">),</span><span class="mi">0</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data_p</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">edge_index</span><span class="o">=</span><span class="n">edge_</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lightgconv</span> <span class="o">=</span> <span class="n">LightGConv</span><span class="p">()</span>
<span class="n">lightgconv</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">data_p</span><span class="o">.</span><span class="n">edge_index</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[-1.1105e+34,  2.0593e-41,  7.2868e-44,  7.2868e-44,  7.4269e-44],
        [-6.8002e+33,  1.2643e-41,  8.2677e-44,  8.5479e-44,  7.7071e-44],
        [ 4.9045e-44,  4.9045e-44,  4.4842e-44,  4.9045e-44,  5.6052e-44],
        [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00],
        [ 7.8473e-44,  6.7262e-44,  7.8473e-44,  7.8473e-44,  7.2868e-44]],
       grad_fn=&lt;ScatterAddBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lrgccf</span> <span class="o">=</span> <span class="n">LRGCCF</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">lrgccf</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">data_p</span><span class="o">.</span><span class="n">edge_index</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[ 4.1829e+31, -1.4982e+33,  1.6885e+33, -2.0696e+32, -2.0293e+33],
        [ 1.8590e+31, -6.6586e+32,  7.5042e+32, -9.1983e+31, -9.0190e+32],
        [ 4.7322e-02,  4.0494e-01, -4.1487e-01, -2.8154e-01, -1.1322e-01],
        [ 4.7322e-02,  4.0494e-01, -4.1487e-01, -2.8154e-01, -1.1322e-01],
        [ 4.7322e-02,  4.0494e-01, -4.1487e-01, -2.8154e-01, -1.1322e-01]],
       grad_fn=&lt;AddmmBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

